===================================================================================
                    تقرير تنفيذ عملية بيع بضاعة للمتجر
===================================================================================

📅 تاريخ التنفيذ: 2024
✅ الحالة: مكتمل 100%

===================================================================================
                            📊 ملخص التنفيذ
===================================================================================

تم تنفيذ عملية "بيع بضاعة من المسوق إلى المتجر" بالكامل وفقاً للمواصفات المذكورة في الملف:
- التطوير_1\3-عملية_بيع_بضاعة_للمتجر.txt
- التطوير_1\7-إدارة_خصومات_الفواتير.txt
- التطوير_1\8-إدارة_العروض_الترويجية.txt

===================================================================================
                        ✅ المكونات المنفذة
===================================================================================

1️⃣ Models (Laravel Eloquent)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ SalesInvoice.php
   - جميع الحقول المطلوبة
   - العلاقات: marketer(), store(), keeper(), items()
   - Casts للحقول المالية والتواريخ

✅ SalesInvoiceItem.php
   - جميع الحقول المطلوبة
   - العلاقات: invoice(), product(), promotion()
   - بدون timestamps

✅ ProductPromotion.php
   - نظام "اشتري X واحصل على Y مجاناً"
   - العلاقات: product(), creator()
   - Casts للتواريخ

✅ InvoiceDiscountTier.php
   - نظام الخصومات التلقائية
   - دعم النسبة المئوية والمبلغ الثابت
   - العلاقات: creator()

2️⃣ API Controllers
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✅ MarketerSalesController.php
   ┌─────────────────────────────────────────────────────────────────┐
   │ index()   - عرض جميع فواتير البيع للمسوق                      │
   │ store()   - إنشاء فاتورة بيع جديدة مع:                        │
   │             • تطبيق العروض الترويجية تلقائياً                 │
   │             • تطبيق خصومات الفواتير تلقائياً                  │
   │             • خصم من marketer_actual_stock                     │
   │             • إضافة إلى store_pending_stock                    │
   │ show()    - عرض تفاصيل فاتورة محددة                           │
   │ cancel()  - إلغاء فاتورة (pending فقط) مع:                   │
   │             • إرجاع البضاعة إلى marketer_actual_stock         │
   │             • حذف من store_pending_stock                       │
   └─────────────────────────────────────────────────────────────────┘

✅ WarehouseSalesController.php
   ┌─────────────────────────────────────────────────────────────────┐
   │ index()   - عرض جميع فواتير البيع من جميع المسوقين            │
   │ show()    - عرض تفاصيل فاتورة محددة                           │
   │ approve() - توثيق الفاتورة مع:                                │
   │             • رفع صورة الفاتورة المختومة                      │
   │             • نقل من store_pending_stock → store_actual_stock │
   │             • تسجيل الدين في store_debt_ledger                │
   └─────────────────────────────────────────────────────────────────┘

3️⃣ Web Controllers
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ Marketer\SalesController.php
   - index()  → marketer/sales/index.blade.php
   - create() → marketer/sales/create.blade.php
   - show()   → marketer/sales/show.blade.php

✅ Warehouse\SalesController.php
   - index() → warehouse/sales/index.blade.php
   - show()  → warehouse/sales/show.blade.php

4️⃣ Views (Blade Templates)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✅ للمسوق (Marketer):
   ┌─────────────────────────────────────────────────────────────────┐
   │ marketer/sales/index.blade.php                                  │
   │ - قائمة جميع فواتير البيع                                      │
   │ - تبويبات للفلترة (الكل، قيد الانتظار، موثقة، ملغية)          │
   │ - بحث برقم الفاتورة واسم المتجر                               │
   │ - عرض الحالة والمبلغ الإجمالي                                 │
   │ - زر "فاتورة جديدة"                                           │
   └─────────────────────────────────────────────────────────────────┘

   ┌─────────────────────────────────────────────────────────────────┐
   │ marketer/sales/create.blade.php                                 │
   │ - اختيار المتجر                                                │
   │ - إضافة منتجات ديناميكياً                                      │
   │ - عرض المنتجات المتوفرة في المخزون الفعلي فقط                │
   │ - حساب الإجمالي تلقائياً                                       │
   │ - ملاحظات اختيارية                                            │
   └─────────────────────────────────────────────────────────────────┘

   ┌─────────────────────────────────────────────────────────────────┐
   │ marketer/sales/show.blade.php                                   │
   │ - تفاصيل الفاتورة الكاملة                                      │
   │ - جدول المنتجات مع الكميات والأسعار                           │
   │ - عرض الكمية المجانية (من العروض)                            │
   │ - Sidebar للإجراءات:                                          │
   │   • إلغاء الفاتورة (pending فقط)                              │
   │   • عرض التوثيق (approved)                                     │
   │ - Modal لعرض صورة التوثيق                                     │
   └─────────────────────────────────────────────────────────────────┘

✅ لأمين المخزن (Warehouse):
   ┌─────────────────────────────────────────────────────────────────┐
   │ warehouse/sales/index.blade.php                                 │
   │ - قائمة جميع فواتير البيع من جميع المسوقين                    │
   │ - تبويبات للفلترة                                              │
   │ - بحث برقم الفاتورة، المسوق، والمتجر                          │
   │ - عرض معلومات المسوق والمتجر والمبلغ                          │
   └─────────────────────────────────────────────────────────────────┘

   ┌─────────────────────────────────────────────────────────────────┐
   │ warehouse/sales/show.blade.php                                  │
   │ - تفاصيل الفاتورة الكاملة                                      │
   │ - جدول المنتجات مع الكميات والأسعار                           │
   │ - Sidebar للإجراءات:                                          │
   │   • توثيق الفاتورة (pending) مع رفع صورة                      │
   │   • عرض التوثيق (approved)                                     │
   │ - Modal لرفع صورة الفاتورة المختومة                           │
   │ - Modal لعرض صورة التوثيق                                     │
   └─────────────────────────────────────────────────────────────────┘

5️⃣ Routes
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ API Routes (routes/api/marketer.php):
   GET    /api/marketer/sales           - قائمة الفواتير
   POST   /api/marketer/sales           - إنشاء فاتورة جديدة
   GET    /api/marketer/sales/{id}      - تفاصيل فاتورة
   PUT    /api/marketer/sales/{id}/cancel - إلغاء فاتورة

✅ API Routes (routes/api/warehouse.php):
   GET    /api/warehouse/sales          - قائمة جميع الفواتير
   GET    /api/warehouse/sales/{id}     - تفاصيل فاتورة
   POST   /api/warehouse/sales/{id}/approve - توثيق فاتورة

✅ Web Routes (routes/web.php):
   GET    /marketer/sales               - قائمة الفواتير
   GET    /marketer/sales/create        - إنشاء فاتورة جديدة
   GET    /marketer/sales/{id}          - تفاصيل فاتورة
   
   GET    /warehouse/sales              - قائمة جميع الفواتير
   GET    /warehouse/sales/{id}         - تفاصيل فاتورة

===================================================================================
                        🔄 دورة حياة الفاتورة
===================================================================================

المرحلة 1: إنشاء الفاتورة (Pending)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
الفاعل: المسوق
الإجراءات:
  1. التحقق من توفر الكميات في marketer_actual_stock
  2. البحث عن عروض ترويجية نشطة (product_promotions)
  3. حساب الكمية المجانية إذا تحقق الشرط
  4. حساب subtotal (الكمية المشتراة × السعر)
  5. البحث عن خصم فاتورة مناسب (invoice_discount_tiers)
  6. تطبيق خصم الفاتورة إذا وجد
  7. حساب total_amount النهائي
  8. إنشاء سجل في sales_invoices
  9. إنشاء سجلات في sales_invoice_items
  10. خصم من marketer_actual_stock (الكمية المشتراة + المجانية)
  11. إضافة إلى store_pending_stock (الكمية الكلية)

الجداول المتأثرة:
  ✅ sales_invoices (INSERT)
  ✅ sales_invoice_items (INSERT)
  ✅ marketer_actual_stock (DECREMENT)
  ✅ store_pending_stock (INSERT)

المرحلة 2: الإلغاء (Cancelled) - اختياري
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
الفاعل: المسوق
الشرط: status = 'pending'
الإجراءات:
  1. إرجاع البضاعة إلى marketer_actual_stock
  2. حذف من store_pending_stock
  3. تحديث status إلى 'cancelled'

الجداول المتأثرة:
  ✅ sales_invoices (UPDATE status)
  ✅ marketer_actual_stock (INCREMENT)
  ✅ store_pending_stock (DELETE)

المرحلة 3: التوثيق (Approved)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
الفاعل: أمين المخزن
الشرط: status = 'pending' + رفع صورة الفاتورة المختومة
الإجراءات:
  1. رفع صورة الفاتورة المختومة
  2. حذف من store_pending_stock
  3. إضافة إلى store_actual_stock (أو تحديث إذا كان موجود)
  4. تسجيل الدين في store_debt_ledger
  5. تحديث sales_invoices (status, keeper_id, stamped_invoice_image, confirmed_at)

الجداول المتأثرة:
  ✅ sales_invoices (UPDATE)
  ✅ store_pending_stock (DELETE)
  ✅ store_actual_stock (INSERT or INCREMENT)
  ✅ store_debt_ledger (INSERT)

===================================================================================
                        💰 نظام الخصومات والعروض
===================================================================================

1️⃣ العروض الترويجية (Product Promotions)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
النظام: "اشتري X واحصل على Y مجاناً"
التطبيق: تلقائي عند إنشاء الفاتورة
الشروط:
  - العرض نشط (is_active = true)
  - ضمن الفترة الزمنية (start_date ≤ اليوم ≤ end_date)
  - الكمية المشتراة ≥ min_quantity

الحساب:
  عدد_المرات = FLOOR(الكمية_المشتراة / min_quantity)
  الكمية_المجانية = عدد_المرات × free_quantity

التأثير:
  ✅ الكمية المجانية تُخصم من مخزون المسوق
  ✅ الكمية المجانية تُضاف لمخزون المتجر
  ❌ الكمية المجانية لا تُحسب في السعر

مثال:
  - العرض: اشتري 10 واحصل على 2 مجاناً
  - الكمية المشتراة: 25
  - عدد المرات: FLOOR(25 / 10) = 2
  - الكمية المجانية: 2 × 2 = 4
  - الكمية الكلية: 25 + 4 = 29
  - السعر: 25 × unit_price (الكمية المجانية لا تُحسب)

2️⃣ خصومات الفواتير (Invoice Discount Tiers)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
النظام: خصم تلقائي بناءً على قيمة الفاتورة
التطبيق: تلقائي عند إنشاء الفاتورة
الشروط:
  - القاعدة نشطة (is_active = true)
  - ضمن الفترة الزمنية (start_date ≤ اليوم ≤ end_date)
  - قيمة الفاتورة ≥ min_amount

الحساب:
  - يتم اختيار القاعدة ذات الحد الأدنى الأعلى التي تنطبق
  - إذا كان discount_type = 'percentage':
    invoice_discount_amount = subtotal × (discount_percentage / 100)
  - إذا كان discount_type = 'fixed':
    invoice_discount_amount = discount_amount

التأثير:
  ✅ يُخصم من المبلغ النهائي
  ✅ يُطبق على subtotal (قبل خصم المنتجات)

مثال:
  - القواعد النشطة:
    • min_amount: 1000, discount: 5%
    • min_amount: 5000, discount: 10%
  - subtotal: 7000
  - القاعدة المطبقة: min_amount: 5000, discount: 10%
  - invoice_discount_amount: 7000 × 0.10 = 700
  - total_amount: 7000 - 700 = 6300

3️⃣ ترتيب تطبيق الخصومات
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
1. تطبيق العروض الترويجية (كمية مجانية)
2. حساب subtotal (الكمية المشتراة × السعر)
3. حساب product_discount (قيمة الكمية المجانية - للعرض فقط)
4. تطبيق invoice_discount (خصم الفاتورة)
5. حساب total_amount (المبلغ النهائي)

الصيغة النهائية:
  total_amount = subtotal - invoice_discount_amount

===================================================================================
                        📊 الميزات المطبقة
===================================================================================

✅ Transactions
   - جميع العمليات محمية بـ DB::beginTransaction()
   - Rollback تلقائي عند حدوث خطأ

✅ Validation
   - التحقق من البيانات في جميع المراحل
   - التحقق من توفر الكميات
   - التحقق من الصلاحيات

✅ Authorization
   - Middleware للتحقق من الأدوار
   - salesman: إنشاء وإلغاء الفواتير
   - warehouse_keeper: توثيق الفواتير

✅ File Upload
   - رفع صورة الفاتورة المختومة عند التوثيق
   - التخزين في storage/app/public/stamped_invoices/

✅ Stock Management
   - خصم من marketer_actual_stock عند الإنشاء
   - إضافة إلى store_pending_stock عند الإنشاء
   - نقل من pending إلى actual عند التوثيق
   - إرجاع عند الإلغاء

✅ Debt Management
   - تسجيل الدين في store_debt_ledger عند التوثيق فقط
   - entry_type = 'sale'
   - amount = total_amount (بعد جميع الخصومات)

✅ Automatic Calculations
   - حساب العروض الترويجية تلقائياً
   - حساب خصومات الفواتير تلقائياً
   - حساب الإجمالي تلقائياً

✅ Responsive Design
   - جميع الواجهات responsive
   - دعم Dark Mode
   - دعم RTL للغة العربية

✅ User Experience
   - تأثيرات حركية سلسة
   - رسائل تأكيد ونجاح
   - Modals للإجراءات المهمة
   - عرض الصور بحجم كامل

===================================================================================
                        🎯 النتيجة النهائية
===================================================================================

✅ تم تنفيذ عملية "بيع بضاعة للمتجر" بالكامل 100%

المراحل المطبقة:
  ✅ إنشاء فاتورة البيع (Pending)
  ✅ الإلغاء (Cancelled)
  ✅ التوثيق النهائي (Approved)

الأنظمة المطبقة:
  ✅ العروض الترويجية (اشتري X واحصل على Y مجاناً)
  ✅ خصومات الفواتير التلقائية (نسبة مئوية أو مبلغ ثابت)
  ✅ إدارة المخزون (actual → pending → actual)
  ✅ إدارة الديون (تسجيل عند التوثيق فقط)

الواجهات المتوفرة:
  ✅ واجهات المسوق (3 صفحات)
  ✅ واجهات أمين المخزن (2 صفحة)
  ✅ تصميم احترافي مع Dark Mode
  ✅ تجربة مستخدم ممتازة

حركة المخزون صحيحة:
  ✅ عند الإنشاء: marketer_actual_stock → store_pending_stock
  ✅ عند التوثيق: store_pending_stock → store_actual_stock
  ✅ عند الإلغاء: store_pending_stock → marketer_actual_stock

الأمان والجودة:
  ✅ استخدام Transactions
  ✅ Validation شامل
  ✅ Authorization صحيح
  ✅ Error Handling

===================================================================================
                        📝 ملاحظات إضافية
===================================================================================

1. العروض الترويجية وخصومات الفواتير تُطبق تلقائياً ولا يمكن للمسوق تعديلها
2. الكمية المجانية تُخصم من مخزون المسوق ولا تُحسب في السعر
3. الدين يُسجل فقط عند التوثيق (approved)
4. السعر المسجل هو السعر وقت البيع (unit_price)
5. يمكن إلغاء الفاتورة فقط في حالة pending
6. عند الإلغاء: البضاعة تعود من المخزون المرحلي إلى المسوق
7. يجب رفع صورة الفاتورة المختومة عند التوثيق

===================================================================================
                        ✅ التوصية
===================================================================================

العملية جاهزة للاستخدام الفوري ولا تحتاج إلى أي تطوير إضافي.
جميع المتطلبات الموثقة في الملفات تم تنفيذها بدقة عالية مع واجهات احترافية.

===================================================================================
