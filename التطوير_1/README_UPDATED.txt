================================================================================
                    📦 Taqnia Distribution Manager - دليل التطوير
================================================================================

🎯 نظرة عامة:
--------------
نظام Taqnia Distribution Manager هو منصة متكاملة لإدارة سلسلة التوزيع والديون.
يهدف إلى تنظيم حركة البضائع والأموال من المصنع إلى المتاجر مع توثيق كامل لكل عملية.

المبدأ الأساسي:
❗ لا توجد أي حركة بضاعة أو أموال بدون فاتورة موثقة.


================================================================================
                        📊 هيكل قاعدة البيانات
================================================================================

إجمالي الجداول: 25 جدول

🔹 الجداول الأساسية (4):
   1. users - المستخدمون
   2. roles - الأدوار
   3. products - المنتجات
   4. stores - المتاجر

🔹 جداول المخزون (7):
   5. main_stock - المخزن الرئيسي
   6. marketer_reserved_stock - مخزون المسوق المحجوز
   7. marketer_actual_stock - مخزون المسوق الفعلي
   8. store_pending_stock - مخزون المتجر المرحلي
   9. store_actual_stock - مخزون المتجر الفعلي
   10. store_return_pending_stock - مخزون الإرجاع المرحلي
   11. warehouse_stock_logs - سجل حركات المخزن

🔹 جداول عمليات المسوق (4):
   12. marketer_requests - طلبات بضاعة
   13. marketer_request_items - تفاصيل الطلبات
   14. marketer_return_requests - طلبات إرجاع
   15. marketer_return_items - تفاصيل الإرجاع

🔹 جداول البيع والديون (5):
   16. sales_invoices - فواتير البيع
   17. sales_invoice_items - تفاصيل الفواتير
   18. store_debt_ledger - دفتر الديون
   19. store_payments - إيصالات القبض
   20. marketer_commissions - عمولات المسوقين

🔹 جداول الإرجاع من المتجر (3):
   21. sales_returns - طلبات الإرجاع
   22. sales_return_items - تفاصيل الإرجاع
   23. (store_return_pending_stock) - مذكور أعلاه

🔹 جداول سحب الأرباح (1):
   24. marketer_withdrawal_requests - طلبات سحب الأرباح

🔹 جداول الخصومات والعروض (2):
   25. product_promotions - العروض الترويجية
   26. invoice_discount_tiers - خصومات الفواتير


================================================================================
                        🔄 العمليات الرئيسية (8 عمليات)
================================================================================

┌─────────────────────────────────────────────────────────────────────────────┐
│ 1️⃣ طلب بضاعة من المسوق                                                     │
└─────────────────────────────────────────────────────────────────────────────┘

📝 الوصف:
   المسوق يطلب بضاعة من المخزن الرئيسي

🔄 المراحل:
   pending → approved → documented
            ↓         ↓
        rejected  cancelled

📦 حركة المخزون:
   • pending: لا تغيير
   • approved: main_stock ↓ / marketer_reserved_stock ↑
   • documented: marketer_reserved_stock ↓ / marketer_actual_stock ↑
   • rejected/cancelled: إرجاع تلقائي

📊 الجداول المتأثرة:
   - marketer_requests
   - marketer_request_items
   - main_stock
   - marketer_reserved_stock
   - marketer_actual_stock
   - warehouse_stock_logs

⚠️ ملاحظات مهمة:
   ✅ البضاعة تُحجز عند الموافقة (approved)
   ✅ يجب رفع صورة الفاتورة الموقعة عند التوثيق
   ✅ لا يمكن إلغاء الطلب بعد التوثيق


┌─────────────────────────────────────────────────────────────────────────────┐
│ 2️⃣ إرجاع بضاعة من المسوق                                                  │
└─────────────────────────────────────────────────────────────────────────────┘

📝 الوصف:
   المسوق يرجع بضاعة إلى المخزن الرئيسي

🔄 المراحل:
   pending → approved → documented
            ↓         ↓
        rejected  cancelled

📦 حركة المخزون:
   • pending: لا تغيير
   • approved: لا تغيير
   • documented: marketer_actual_stock ↓ / main_stock ↑ (مباشرة)
   • rejected/cancelled: لا تغيير

📊 الجداول المتأثرة:
   - marketer_return_requests
   - marketer_return_items
   - marketer_actual_stock
   - main_stock
   - warehouse_stock_logs

⚠️ ملاحظات مهمة:
   ✅ البضاعة تنتقل مباشرة: actual → main (بدون مرور على المحجوز)
   ✅ لا يمكن إرجاع كمية أكبر من الموجودة


┌─────────────────────────────────────────────────────────────────────────────┐
│ 3️⃣ بيع بضاعة للمتجر                                                        │
└─────────────────────────────────────────────────────────────────────────────┘

📝 الوصف:
   المسوق يبيع بضاعة للمتجر

🔄 المراحل:
   pending → approved
      ↓
   cancelled

📦 حركة المخزون:
   • pending: marketer_actual_stock ↓ / store_pending_stock ↑
   • approved: store_pending_stock ↓ / store_actual_stock ↑
   • cancelled: إرجاع إلى marketer_actual_stock

💰 حركة الديون:
   • الدين يُسجل فقط عند التوثيق (approved)

📊 الجداول المتأثرة:
   - sales_invoices
   - sales_invoice_items
   - marketer_actual_stock
   - store_pending_stock
   - store_actual_stock
   - store_debt_ledger

⚠️ ملاحظات مهمة:
   ✅ يتم تطبيق العروض الترويجية تلقائياً
   ✅ يتم تطبيق خصومات الفواتير تلقائياً
   ✅ السعر المسجل هو السعر وقت البيع


┌─────────────────────────────────────────────────────────────────────────────┐
│ 4️⃣ إيصال القبض (تسديد دين المتجر)                                         │
└─────────────────────────────────────────────────────────────────────────────┘

📝 الوصف:
   المتجر يسدد دينه

🔄 المراحل:
   pending → approved
      ↓         ↓
   cancelled rejected

💰 حركة الديون:
   • الدين يُخصم فقط عند التوثيق (approved)
   • العمولة تُسجل للمسوق عند التوثيق

📊 الجداول المتأثرة:
   - store_payments
   - store_debt_ledger
   - marketer_commissions

⚠️ ملاحظات مهمة:
   ✅ العمولة = المبلغ × نسبة العمولة (من users.commission_rate)
   ✅ التسديد لا يرتبط بفاتورة محددة
   ✅ طرق الدفع: نقدي / تحويل / شيك مصدق


┌─────────────────────────────────────────────────────────────────────────────┐
│ 5️⃣ سحب أرباح المسوق                                                        │
└─────────────────────────────────────────────────────────────────────────────┘

📝 الوصف:
   المسوق يسحب أرباحه (عمولاته)

🔄 المراحل:
   pending → approved
      ↓         ↓
   cancelled rejected

💰 حساب الرصيد:
   الرصيد المتاح = مجموع العمولات - مجموع السحوبات

📊 الجداول المتأثرة:
   - marketer_withdrawal_requests
   - marketer_commissions (للقراءة فقط)

⚠️ ملاحظات مهمة:
   ✅ لا يمكن السحب بمبلغ أكبر من الرصيد المتاح
   ✅ يدعم التقسيط (عدة طلبات سحب)
   ✅ الحساب ديناميكي (لا يوجد حقل balance)
   ✅ يجب رفع صورة إيصال الاستلام الموقع


┌─────────────────────────────────────────────────────────────────────────────┐
│ 6️⃣ إرجاع بضاعة من المتجر                                                  │
└─────────────────────────────────────────────────────────────────────────────┘

📝 الوصف:
   المتجر يرجع بضاعة للمسوق

🔄 المراحل:
   pending → approved
      ↓         ↓
   cancelled rejected

📦 حركة المخزون:
   • pending: store_actual_stock ↓ / store_return_pending_stock ↑
   • approved: store_return_pending_stock ↓ / marketer_actual_stock ↑
   • cancelled/rejected: إرجاع إلى store_actual_stock

💰 حركة الديون:
   • الدين يُخصم فقط عند التوثيق (approved)
   • ⚠️ لا تتأثر عمولات المسوق بالإرجاع

📊 الجداول المتأثرة:
   - sales_returns
   - sales_return_items
   - store_actual_stock
   - store_return_pending_stock
   - marketer_actual_stock
   - store_debt_ledger

⚠️ ملاحظات مهمة:
   ✅ السعر المستخدم = السعر من الفاتورة الأصلية
   ✅ لا تتأثر العمولات بالإرجاع


┌─────────────────────────────────────────────────────────────────────────────┐
│ 7️⃣ إدارة خصومات الفواتير                                                  │
└─────────────────────────────────────────────────────────────────────────────┘

📝 الوصف:
   خصومات تلقائية على الفواتير بناءً على القيمة

🎯 أنواع الخصم:
   • percentage: نسبة مئوية
   • fixed: مبلغ ثابت

📊 كيفية العمل:
   1. حساب subtotal
   2. البحث عن قاعدة خصم مناسبة (min_amount <= subtotal)
   3. تطبيق الخصم تلقائياً
   4. حساب total_amount

📊 الجداول المتأثرة:
   - invoice_discount_tiers
   - sales_invoices

⚠️ ملاحظات مهمة:
   ❌ ممنوع تعديل قيم الخصم بعد الإنشاء
   ✅ للتغيير: عطّل القديم وأنشئ جديد
   ✅ يمكن فقط التفعيل/التعطيل (is_active)


┌─────────────────────────────────────────────────────────────────────────────┐
│ 8️⃣ إدارة العروض الترويجية                                                 │
└─────────────────────────────────────────────────────────────────────────────┘

📝 الوصف:
   عروض "اشتري X واحصل على Y مجاناً"

🎯 كيفية العمل:
   1. التحقق من الكمية >= min_quantity
   2. حساب عدد المرات = FLOOR(الكمية / min_quantity)
   3. الكمية المجانية = عدد المرات × free_quantity
   4. خصم الكمية الكلية من مخزون المسوق

📊 الجداول المتأثرة:
   - product_promotions
   - sales_invoice_items
   - marketer_actual_stock

⚠️ ملاحظات مهمة:
   ✅ الكمية المجانية تخصم من المخزون
   ✅ الكمية المجانية لا تحسب في السعر
   ❌ ممنوع تعديل شروط العرض بعد الإنشاء
   ✅ للتغيير: عطّل القديم وأنشئ جديد


================================================================================
                        💡 نصائح تقنية متقدمة
================================================================================

📝 ملاحظة:
   للحصول على خطة التطوير التفصيلية مع API + Blade Views،
   راجع ملف: API_PLAN.txt


================================================================================
                        💡 نصائح تقنية أساسية
================================================================================

🔹 استخدام Transactions:
   DB::beginTransaction();
   try {
       // العمليات
       DB::commit();
   } catch (\Exception $e) {
       DB::rollBack();
       throw $e;
   }

🔹 استخدام Locks:
   $product = Product::where('id', $id)->lockForUpdate()->first();

🔹 استخدام Events & Listeners:
   Event: InvoiceApproved
   Listener: UpdateStock, CreateDebt, SendNotification

🔹 استخدام Scopes:
   public function scopeActive($query) {
       return $query->where('is_active', true);
   }

🔹 استخدام Eager Loading:
   $invoices = Invoice::with(['items.product', 'marketer'])->get();


================================================================================
                        🔐 الأمان والحماية
================================================================================

✅ المصادقة:
   - Laravel Sanctum للـ API
   - Middleware للصلاحيات (IsAdmin, IsKeeper, IsMarketer)

✅ حماية البيانات:
   - تشفير كلمات المرور (bcrypt)
   - Validation لجميع المدخلات
   - CSRF Protection
   - Rate Limiting

✅ حماية الملفات:
   - تخزين الصور في storage/app/private
   - التحقق من نوع الملف
   - تحديد حجم الملف


================================================================================
                        📊 الوقت الإجمالي المتوقع
================================================================================

المرحلة 1: 1-2 يوم
المرحلة 2: 2-3 أيام
المرحلة 3: 2-3 أيام
المرحلة 4: 4-5 أيام
المرحلة 5: 5-6 أيام
المرحلة 6: 3-4 أيام
المرحلة 7: 3-4 أيام
المرحلة 8: 7-10 أيام

الإجمالي: 27-37 يوم عمل (حوالي 5-7 أسابيع)


================================================================================
                        ✅ قائمة التحقق (Checklist)
================================================================================

□ المرحلة 1: البنية التحتية
  □ تثبيت Laravel
  □ تثبيت المكتبات
  □ ضبط .env

□ المرحلة 2: الجداول الأساسية
  □ Migrations
  □ Models
  □ Seeders

□ المرحلة 3: جداول المخزون
  □ Migrations
  □ Models
  □ Indexes

□ المرحلة 4: عمليات المسوق
  □ Migrations
  □ Models
  □ Controllers
  □ Services
  □ Routes

□ المرحلة 5: البيع والديون
  □ Migrations
  □ Models
  □ Controllers
  □ Services
  □ منطق الحسابات

□ المرحلة 6: الإرجاع
  □ Migrations
  □ Controllers
  □ Services

□ المرحلة 7: الميزات الإضافية
  □ Migrations
  □ Controllers
  □ منطق العروض والخصومات

□ المرحلة 8: الواجهات
  □ Dashboard
  □ Panels
  □ Reports


================================================================================
                        📝 ملاحظات نهائية
================================================================================

📌 للحصول على خطة التطوير التفصيلية:
   راجع ملف: API_PLAN.txt
   (يحتوي على 9 مراحل تطوير مع API + Blade Views)

⚠️ قواعد مهمة:
   1. ✅ كل حركة بضاعة أو مال يجب أن تكون موثقة
   2. ✅ استخدم Transactions لجميع عمليات المخزون
   3. ✅ لا تعدل العروض/الخصومات بعد الإنشاء
   4. ✅ الحسابات الديناميكية أفضل من الحقول الثابتة
   5. ✅ السعر المسجل = السعر وقت البيع
   6. ✅ العمولات تتأثر بالتسديد فقط (ليس بالإرجاع)

🎯 الأهداف:
   - شفافية كاملة
   - منع النزاعات
   - إدارة دقيقة للمخزون
   - نظام ديون مرن
   - قابل للتوسع

================================================================================
