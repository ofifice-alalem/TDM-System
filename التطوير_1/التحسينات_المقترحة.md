# ๐ง ุงูุชุญุณููุงุช ุงูููุชุฑุญุฉ ููุธุงู TDM

## ๐ ูุธุฑุฉ ุนุงูุฉ

ูุฐุง ุงูููู ูุญุชูู ุนูู ุงูุชุญุณููุงุช ุงูููุชุฑุญุฉ ูุนูููุฉ ุทูุจ ุจุถุงุนุฉ ูู ุงููุณูู.
ุฌููุน ุงูุชุญุณููุงุช **ุงุฎุชูุงุฑูุฉ** ูุงููุธุงู ูุนูู ุจุดูู ุตุญูุญ ุจุฏูููุง.

---

## ๐ก ุงูุชุญุณูู 1: ุฅุฒุงูุฉ ุงูุชุณุฌูู ุงูููุฑุฑ ูู warehouse_stock_logs

### ุงููุดููุฉ:
ูุชู ุชุณุฌูู ุงูุญุฑูุฉ ูุฑุชูู:
1. ุนูุฏ ุงูููุงููุฉ (approve)
2. ุนูุฏ ุงูุชูุซูู (document)

### ุงูุญู ุงูููุตู ุจู:
ุชุณุฌูู ุงูุญุฑูุฉ ููุท ุนูุฏ ุงูุชูุซูู ุงูููุงุฆู

### ุงูููุฏ ุงูููุชุฑุญ:

#### ูู WarehouseRequestController@approve
```php
public function approve($id)
{
    DB::beginTransaction();
    try {
        $request = DB::table('marketer_requests')->where('id', $id)->where('status', 'pending')->first();
        if (!$request) {
            return response()->json(['message' => 'ุงูุทูุจ ุบูุฑ ููุฌูุฏ ุฃู ุชู ูุนุงูุฌุชู ูุณุจูุงู'], 404);
        }

        $items = DB::table('marketer_request_items')->where('request_id', $id)->get();

        foreach ($items as $item) {
            $stock = DB::table('main_stock')->where('product_id', $item->product_id)->first();
            if (!$stock || $stock->quantity < $item->quantity) {
                DB::rollBack();
                return response()->json(['message' => 'ุงููุฎุฒูู ุบูุฑ ูุงูู'], 400);
            }

            DB::table('main_stock')->where('product_id', $item->product_id)
                ->decrement('quantity', $item->quantity);

            $reserved = DB::table('marketer_reserved_stock')
                ->where('marketer_id', $request->marketer_id)
                ->where('product_id', $item->product_id)
                ->first();

            if ($reserved) {
                DB::table('marketer_reserved_stock')
                    ->where('marketer_id', $request->marketer_id)
                    ->where('product_id', $item->product_id)
                    ->increment('quantity', $item->quantity);
            } else {
                DB::table('marketer_reserved_stock')->insert([
                    'marketer_id' => $request->marketer_id,
                    'product_id' => $item->product_id,
                    'quantity' => $item->quantity,
                    'created_at' => now(),
                    'updated_at' => now()
                ]);
            }
        }

        // โ ุฅุฒุงูุฉ ูุฐุง ุงูุฌุฒุก - ูุง ูุณุฌู ูู warehouse_stock_logs ุนูุฏ ุงูููุงููุฉ
        // DB::table('warehouse_stock_logs')->insert([...]);

        DB::table('marketer_requests')->where('id', $id)->update([
            'status' => 'approved',
            'approved_by' => auth()->id(),
            'approved_at' => now(),
            'updated_at' => now()
        ]);

        DB::commit();
        return response()->json(['message' => 'ุชูุช ุงูููุงููุฉ ุนูู ุงูุทูุจ ุจูุฌุงุญ']);
    } catch (\Exception $e) {
        DB::rollBack();
        return response()->json(['message' => 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูููุงููุฉ'], 500);
    }
}
```

#### ูู WarehouseRequestController@document
```php
// โ ุงูุฅุจูุงุก ุนูู ุงูุชุณุฌูู ููุง ููุท
DB::table('warehouse_stock_logs')->insert([
    'invoice_type' => 'marketer_request',
    'invoice_id' => $id,
    'keeper_id' => auth()->id(),
    'action' => 'withdraw',
    'created_at' => now()
]);
```

---

## ๐ก ุงูุชุญุณูู 2: ุญุฐู ุงูุณุฌูุงุช ุฐุงุช ุงููููุฉ ุตูุฑ

### ุงููุดููุฉ:
ุนูุฏ ุฎุตู ุงููููุงุช ูู `marketer_reserved_stock`ุ ูุฏ ุชุตุจุญ ุงููููุฉ = 0 ูููู ุงูุณุฌู ูุจูู ููุฌูุฏุงู.

### ุงูุญู:
ุญุฐู ุงูุณุฌู ุฅุฐุง ุฃุตุจุญุช ุงููููุฉ = 0

### ุงูููุฏ ุงูููุชุฑุญ:

#### ุฏุงูุฉ ูุณุงุนุฏุฉ (Helper Function)
```php
/**
 * ุฎุตู ูู ุงููุฎุฒูู ุงููุญุฌูุฒ ูุญุฐู ุงูุณุฌู ุฅุฐุง ุฃุตุจุญุช ุงููููุฉ ุตูุฑ
 */
private function decrementReservedStock($marketerId, $productId, $quantity)
{
    DB::table('marketer_reserved_stock')
        ->where('marketer_id', $marketerId)
        ->where('product_id', $productId)
        ->decrement('quantity', $quantity);

    // ุญุฐู ุงูุณุฌู ุฅุฐุง ุฃุตุจุญุช ุงููููุฉ ุตูุฑ ุฃู ุฃูู
    DB::table('marketer_reserved_stock')
        ->where('marketer_id', $marketerId)
        ->where('product_id', $productId)
        ->where('quantity', '<=', 0)
        ->delete();
}
```

#### ุงุณุชุฎุฏุงููุง ูู reject()
```php
public function reject(Request $request, $id)
{
    $request->validate(['notes' => 'required|string']);

    DB::beginTransaction();
    try {
        $marketerRequest = DB::table('marketer_requests')->where('id', $id)->first();
        if (!$marketerRequest || !in_array($marketerRequest->status, ['pending', 'approved'])) {
            return response()->json(['message' => 'ุงูุทูุจ ุบูุฑ ููุฌูุฏ ุฃู ูุง ูููู ุฑูุถู'], 404);
        }

        if ($marketerRequest->status === 'approved') {
            $items = DB::table('marketer_request_items')->where('request_id', $id)->get();
            foreach ($items as $item) {
                DB::table('main_stock')->where('product_id', $item->product_id)
                    ->increment('quantity', $item->quantity);

                // โ ุงุณุชุฎุฏุงู ุงูุฏุงูุฉ ุงููุณุงุนุฏุฉ
                $this->decrementReservedStock(
                    $marketerRequest->marketer_id,
                    $item->product_id,
                    $item->quantity
                );
            }

            DB::table('warehouse_stock_logs')->insert([
                'invoice_type' => 'marketer_request',
                'invoice_id' => $id,
                'keeper_id' => auth()->id(),
                'action' => 'return',
                'created_at' => now()
            ]);
        }

        DB::table('marketer_requests')->where('id', $id)->update([
            'status' => 'rejected',
            'rejected_by' => auth()->id(),
            'rejected_at' => now(),
            'notes' => $request->notes,
            'updated_at' => now()
        ]);

        DB::commit();
        return response()->json(['message' => 'ุชู ุฑูุถ ุงูุทูุจ']);
    } catch (\Exception $e) {
        DB::rollBack();
        return response()->json(['message' => 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฑูุถ ุงูุทูุจ'], 500);
    }
}
```

#### ุงุณุชุฎุฏุงููุง ูู cancel()
```php
// ููุณ ุงูุทุฑููุฉ ูู MarketerRequestController@cancel
// ู WarehouseRequestController@cancel
```

#### ุงุณุชุฎุฏุงููุง ูู document()
```php
public function document(Request $request, $id)
{
    $request->validate([
        'stamped_image' => 'required|image|max:10240'
    ]);

    DB::beginTransaction();
    try {
        $marketerRequest = DB::table('marketer_requests')->where('id', $id)->where('status', 'approved')->first();
        if (!$marketerRequest) {
            return response()->json(['message' => 'ุงูุทูุจ ุบูุฑ ููุฌูุฏ ุฃู ุบูุฑ ููุงูู ุนููู'], 404);
        }

        $imagePath = null;
        if ($request->hasFile('stamped_image')) {
            $invoiceNumber = $marketerRequest->invoice_number;
            $directory = "stamed_request/{$invoiceNumber}";
            $imagePath = $request->file('stamped_image')->store($directory, 'public');
        }

        $items = DB::table('marketer_request_items')->where('request_id', $id)->get();

        foreach ($items as $item) {
            // โ ุงุณุชุฎุฏุงู ุงูุฏุงูุฉ ุงููุณุงุนุฏุฉ
            $this->decrementReservedStock(
                $marketerRequest->marketer_id,
                $item->product_id,
                $item->quantity
            );

            $actual = DB::table('marketer_actual_stock')
                ->where('marketer_id', $marketerRequest->marketer_id)
                ->where('product_id', $item->product_id)
                ->first();

            if ($actual) {
                DB::table('marketer_actual_stock')
                    ->where('marketer_id', $marketerRequest->marketer_id)
                    ->where('product_id', $item->product_id)
                    ->increment('quantity', $item->quantity);
            } else {
                DB::table('marketer_actual_stock')->insert([
                    'marketer_id' => $marketerRequest->marketer_id,
                    'product_id' => $item->product_id,
                    'quantity' => $item->quantity
                ]);
            }
        }

        DB::table('marketer_requests')->where('id', $id)->update([
            'status' => 'documented',
            'documented_by' => auth()->id(),
            'documented_at' => now(),
            'stamped_image' => $imagePath,
            'updated_at' => now()
        ]);

        DB::table('warehouse_stock_logs')->insert([
            'invoice_type' => 'marketer_request',
            'invoice_id' => $id,
            'keeper_id' => auth()->id(),
            'action' => 'withdraw',
            'created_at' => now()
        ]);

        DB::commit();
        return response()->json(['message' => 'ุชู ุชูุซูู ุงุณุชูุงู ุงูุจุถุงุนุฉ ุจูุฌุงุญ']);
    } catch (\Exception $e) {
        DB::rollBack();
        return response()->json(['message' => 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุชูุซูู'], 500);
    }
}
```

---

## ๐ข ุชุญุณูู ุฅุถุงูู: ุงุณุชุฎุฏุงู Eloquent ุจุฏูุงู ูู Query Builder

### ุงููุงุฆุฏุฉ:
- ููุฏ ุฃูุธู ูุฃูุตุฑ
- ุงุณุชุฎุฏุงู ุงูุนูุงูุงุช
- Type hinting ุฃูุถู

### ูุซุงู:

#### ูุจู (Query Builder):
```php
$request = DB::table('marketer_requests')
    ->where('id', $id)
    ->where('marketer_id', $request->user()->id)
    ->first();
```

#### ุจุนุฏ (Eloquent):
```php
$marketerRequest = MarketerRequest::where('id', $id)
    ->where('marketer_id', $request->user()->id)
    ->with(['items.product', 'approver', 'documenter'])
    ->first();
```

---

## ๐ ููุฎุต ุงูุชุญุณููุงุช

| ุงูุชุญุณูู | ุงูุฃููููุฉ | ุงูุชุฃุซูุฑ | ุงูุตุนูุจุฉ |
|---------|----------|---------|---------|
| ุฅุฒุงูุฉ ุงูุชุณุฌูู ุงูููุฑุฑ | ูุชูุณุทุฉ | ููุฎูุถ | ุณูู |
| ุญุฐู ุงูุณุฌูุงุช ุฐุงุช ุงููููุฉ ุตูุฑ | ููุฎูุถุฉ | ููุฎูุถ | ุณูู |
| ุงุณุชุฎุฏุงู Eloquent | ููุฎูุถุฉ | ูุชูุณุท | ูุชูุณุท |

---

## โ ุงูุฎูุงุตุฉ

- ุฌููุน ุงูุชุญุณููุงุช **ุงุฎุชูุงุฑูุฉ**
- ุงููุธุงู ูุนูู ุจุดูู ุตุญูุญ ุจุฏูููุง
- ูููู ุชุทุจูููุง ุชุฏุฑูุฌูุงู
- ูุง ุชุคุซุฑ ุนูู ุงููุธุงุฆู ุงูุฃุณุงุณูุฉ

---

**ุชุงุฑูุฎ ุงูุฅูุดุงุก:** 2025
**ุงูุญุงูุฉ:** ๐ ููุชุฑุญุงุช
