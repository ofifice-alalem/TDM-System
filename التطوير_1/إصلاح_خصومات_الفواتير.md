# إصلاح خصومات الفواتير في صفحة إنشاء فاتورة البيع

## المشكلة
1. **خطأ 403 Forbidden**: المسوق يحاول الوصول لـ `/api/admin/discounts` وهو endpoint خاص بالـ admin فقط
2. **عدم تطبيق الخصومات**: خصم الفاتورة يظهر دائماً 0.00 دينار

## الحل المطبق

### 1. إنشاء Endpoint عام للخصومات النشطة
**الملف**: `routes/api/common.php`

```php
// Active Invoice Discounts (accessible by all authenticated users)
Route::get('/discounts/active', function() {
    $discounts = \DB::table('invoice_discount_tiers')
        ->where('is_active', true)
        ->whereDate('start_date', '<=', now())
        ->whereDate('end_date', '>=', now())
        ->orderBy('min_amount', 'desc')
        ->get();
    return response()->json(['data' => $discounts]);
});
```

**المميزات**:
- ✅ متاح لجميع المستخدمين المصادق عليهم (admin, warehouse_keeper, salesman)
- ✅ يرجع فقط الخصومات النشطة والصالحة حالياً
- ✅ مرتبة حسب الحد الأدنى للمبلغ (تنازلياً)

### 2. تحديث صفحة إنشاء الفاتورة
**الملف**: `resources/views/marketer/sales/create.blade.php`

**التغييرات**:
```javascript
// قبل
fetch('/api/admin/discounts', { ... })

// بعد
fetch('/api/discounts/active', { ... })
```

**منطق تطبيق الخصومات** (موجود بالفعل):
```javascript
function updateSummary() {
    // حساب المجموع الفرعي
    let subtotal = 0;
    // ... حساب subtotal
    
    // تطبيق خصم الفاتورة
    let invoiceDiscount = 0;
    if (window.discounts && subtotal > 0) {
        const applicable = window.discounts
            .filter(d => parseFloat(d.min_amount) <= subtotal)
            .sort((a, b) => parseFloat(b.min_amount) - parseFloat(a.min_amount))[0];
        
        if (applicable) {
            if (applicable.discount_type === 'percentage') {
                invoiceDiscount = subtotal * (parseFloat(applicable.discount_percentage) / 100);
            } else {
                invoiceDiscount = parseFloat(applicable.discount_amount);
            }
        }
    }
    
    // عرض النتائج
    document.getElementById('invoiceDiscountValue').textContent = formatter.format(invoiceDiscount) + ' د';
}
```

## كيفية عمل النظام

### مثال عملي:
1. **المسوق يختار منتجات** بمجموع فرعي = 1000 دينار
2. **النظام يبحث عن الخصومات المتاحة**:
   - خصم 1: حد أدنى 500 د → خصم 5%
   - خصم 2: حد أدنى 1000 د → خصم 10%
   - خصم 3: حد أدنى 2000 د → لا ينطبق
3. **يختار أعلى خصم ينطبق**: خصم 2 (10%)
4. **يحسب الخصم**: 1000 × 10% = 100 دينار
5. **المجموع النهائي**: 1000 - 100 = 900 دينار

## الفوائد
✅ **حل مشكلة الصلاحيات**: المسوق الآن يمكنه الوصول للخصومات
✅ **تطبيق تلقائي**: الخصومات تُطبق فوراً عند تغيير المنتجات أو الكميات
✅ **شفافية كاملة**: المسوق يرى قيمة الخصم قبل إنشاء الفاتورة
✅ **نفس المنطق**: يستخدم نفس منطق الحساب الموجود في الـ Controller

## الاختبار
1. افتح صفحة إنشاء فاتورة بيع: `/marketer/sales/create`
2. اختر متجر ومنتجات
3. لاحظ تحديث "خصم الفاتورة" تلقائياً عند تغيير الكميات
4. تأكد من عدم وجود أخطاء 403 في Console

## ملاحظات
- الخصومات تُطبق فقط على المجموع الفرعي (قبل خصم المنتجات)
- يتم اختيار أعلى خصم ينطبق على المبلغ
- الخصومات المنتهية أو غير النشطة لا تظهر
